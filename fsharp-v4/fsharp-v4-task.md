# F# v4 Task Description: Minimal NSwag-Based Client with Streaming

## Project Overview

This is the **fourth iteration** of exploring the NOCFO API with F#. Previous attempts revealed that while F# showed promise, the code was overly complex with multiple projects and excessive manual implementation. This iteration takes a different approach: **maximize tool usage, minimize LLM-generated code**.

Remember that we are running under macOS, using Cursor (a VSCode variant) as our environment.  Prefer Homebrew for installing tools.

## Core Philosophy

**Use tools, not AI, for plumbing. Use AI for high-level abstractions.**

- **NSwag** will generate a small, idiomatic C# client (classes and DTOs), which we then consume from F#:
  - All needed DTO types (Business, Account, PaginatedAccountListList)
  - HTTP client with proper request building
  - Serialization/deserialization
  - Authentication handling hooks

- **AI/LLM will create**:
  - Minimal AsyncSeq-based stream abstractions
  - Simple wrapper functions
  - A concise console tool to demonstrate functionality

## Goals

### First Goal: Stream of Accounts

**Generate an `AsyncSeq` stream of all accounts for a given business.**

The stream should handle pagination automatically, fetching all pages and yielding accounts as they become available.
Note that AsyncSeq is pull based. Hence, in this case, we simply pull all data until we reach an end.

### Secondary Goals

1. **Minimal project structure**: One source folder, the LLM generated files as a few short files (or maybe only one)
2. **Leverage tooling**: NSwag for the heavy lifting (generate C# client we call from F#)
3. **Clean abstractions**: Simple, readable streaming API
4. **Working demo**: Console tool that fetches and displays accounts

## Project Structure

```
fsharp-v4/
├── nocfo-api-client/          # Generated by NSwag (C#)
│   └── NocfoClient.cs         # Client + DTOs (generated)
├── src/
│   ├── Streams.fs             # AsyncSeq abstractions (LLM-generated, minimal)
│   └── Program.fs             # Simple console tool (LLM-generated)
├── fsharp-v4.fsproj           # F# project that includes NocfoClient.cs
├── NocfoClient.sln            # Simple solution file
└── README.md                  # Setup instructions
```

## Implementation Steps

### Step 1: Setup and NSwag Generation

**Files to create/configure:**
1. `nocfo.nswag.json` (already added) – NSwag configuration
2. `generate-client.sh` – Script to run generation: `nswag run nocfo.nswag.json`

**Key requirements:**
- Use NSwag to generate a C# client class and DTOs
- Input OpenAPI spec at `api/openapi.json`
- Configure base URL via environment or NSwag option
- Include authentication header injection (Token-based auth)

**Expected output:**
- C# client file with all endpoints we need: `nocfo-api-client/NocfoClient.cs`
- All needed DTO types (Business, Account, etc.) and no extras
- Minimal code surface, single file if feasible

### Step 2: Create Stream Abstractions

**File: `Streams.fs`** (minimal LLM-generated code)

This file should provide:

1. **Account Streaming Function**
   ```fsharp
   val getAccountsStream : businessSlug: string -> AsyncSeq<Account>
   ```
   - Takes a business slug
   - Automatically handles pagination
   - Returns AsyncSeq of Account objects
   - Handles `next` links from API responses

2. **Helper Functions** (if needed)
   - Generic pagination handling
   - Error handling
   - Retry logic (optional)

**Key constraints:**
- Keep this file under 100 lines if possible
- Use AsyncSeq from `FSharp.Control.AsyncSeq`
- Handle the API's pagination structure, if needed (`count`, `results`, `next`, `previous`)

### Step 3: Create Console Tool

**File: `Program.fs`** (simple demonstration)

The tool should:
1. Read `NOCFO_API_TOKEN` environment variable
2. Get first business from the system (or use a hardcoded test business slug)
3. Stream all accounts for that business
4. Display account information (id, number, name, type, balance)
5. Show total count at the end

**Expected output format:**
```
NOCFO Account Stream Demo
=============================
Streaming accounts for business: test-oy-12345...
Account #1: [1000] Bank Account (ASS_PAY) - Balance: 15234.56 €
Account #2: [1200] Trade Receivables (ASS_DUE) - Balance: 5421.30 €
...
Total accounts: 42
```

### Step 4: Solution and Project Configuration

**Files to create:**
1. `NocfoClient.sln` - Visual Studio solution file
2. `fsharp-v4.fsproj` - F# project referencing `nocfo-api-client/NocfoClient.cs`

**Dependencies:**
- `FSharp.Control.AsyncSeq` - For streaming
- NSwag CLI (e.g., `dotnet tool install --global NSwag.ConsoleCore` or Homebrew if available)
- .NET SDK 9.0

## Technical Specifications

### API Details

- **Base URL**: `https://api-tst.nocfo.io`
- **Authentication**: `Authorization: Token <token>`
- **Endpoint**: `GET /v1/business/{business_slug}/account/`
- **Pagination**:
  - Query params: `page`, `page_size`
  - Response: `{ count, results, next, previous }`
  - Default page_size: typically 100

### Response Structure

The accounts endpoint returns:
```json
{
  "count": 123,
  "next": "https://api-tst.nocfo.io/v1/business/slug/account/?page=2",
  "previous": null,
  "results": [
    {
      "id": 1,
      "number": "1000",
      "padded_number": 1000,
      "name": "Bank Account",
      "type": "ASS_PAY",
      "balance": 15234.56,
      "is_used": true,
      "is_shown": true,
      ...
    },
    ...
  ]
}
```

### Account Type Enum

The API uses these account types (Finnish accounting):
- **Assets**: `ASS`, `ASS_DEP`, `ASS_DUE`, `ASS_PAY`, `ASS_REC`, `ASS_VAT`
- **Liabilities**: `LIA`, `LIA_ACC`, `LIA_DEB`, `LIA_DUE`, `LIA_EQU`, `LIA_PRE`, `LIA_VAT`
- **Revenue**: `REV`, `REV_NO`, `REV_SAL`
- **Expenses**: `EXP`, `EXP_50`, `EXP_DEP`, `EXP_NO`, `EXP_TAX`, `EXP_TAX_PRE`

## Success Criteria

1. ✅ NSwag successfully generates client (`NocfoClient.cs`)
2. ✅ `Streams.fs` contains minimal, working AsyncSeq implementation
3. ✅ `Program.fs` demonstrates streaming accounts from API
4. ✅ Code compiles and runs successfully
5. ✅ Console output shows accounts streaming in real-time
6. ✅ Total project has fewer than 500 lines of human/LLM-written code
7. ✅ Generated code (from OpenAPI) is separate and clearly marked

## Risk Mitigation

### Potential Issues

1. **NSwag configuration**: May need tweaks to minimize output and set base URL
   - Mitigation: Start from `nocfo.nswag.json`, iterate options
   - Keep single-file output to preserve minimality

2. **AsyncSeq integration**: Generated client returns Tasks; wrap into AsyncSeq
   - Mitigation: Create thin wrapper functions that convert Task<T> to AsyncSeq
   - Use `AsyncSeq.unfoldAsync` to paginate using `next` URLs

3. **Authentication format**: Must match API's Token-based auth
   - Mitigation: Verify exact header format in generated code
   - Test with real API token early

4. **Pagination handling**: Must correctly parse `next` links
   - Mitigation: Test with businesses that have multiple pages
   - Add logging to debug pagination

### Testing Strategy

1. **Local generation test**: Generate client, verify it compiles
2. **Mock API test**: Test streaming with static data
3. **Real API test**: Test with NOCFO test environment
4. **Edge case test**: Test with businesses that have 0 accounts, 1 account, many accounts

## Deliverables

1. Working F# console application
2. Generated client code (clearly marked as generated)
3. Minimal wrapper code (less than 200 lines total)
4. README with setup instructions
5. Scripts to regenerate client from OpenAPI spec

## Next Steps After This Task

If this succeeds, potential next steps:
1. Stream businesses (already working in v3, can replicate pattern)
2. Stream transactions/documents
3. Add filtering and mapping operations
4. Create more sophisticated financial calculations
5. Explore Enable Banking or PSD2 APIs with same pattern

## Timeline

- **Step 1**: OpenAPI setup and generation (est. 1-2 hours)
- **Step 2**: Stream abstraction creation (est. 1 hour)
- **Step 3**: Console tool creation (est. 30 minutes)
- **Step 4**: Testing and refinement (est. 1 hour)

**Total estimated time**: 3-4 hours

## References

- NSwag: https://github.com/RicoSuter/NSwag
- FSharp.Control.AsyncSeq: https://github.com/fsprojects/FSharp.Control.AsyncSeq
- NOCFO API Docs: https://api-tst.nocfo.io/docs
- Previous attempts: See `LESSONS-LEARNED.md`
